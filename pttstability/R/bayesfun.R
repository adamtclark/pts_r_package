#' Parse parameters
#'
#' Takes in a vector of 6 or 8 parameters, and puts them into a list of the format expected by the particleFilterLL function.
#' @param param List of 6 or 8 paramters, in the order (obs1, obs2, proc1, proc2, pcol1, pcol2, det1, det2).
#' Note that if param is of length 6, then detparam must be supplied. See obsfun0, procfun0, and detfun0 for more details.
#' @param detparam Optional vector of length two, including paramters for the deterministic function.
#' @keywords stability, time-series, particle filter
#' @return a formatted list of parameters
#' @export

parseparam0<-function(param, detparam=c(log(3),log(1))) {
  if(length(param)==6) {
    pars<-list(obs=c(param[1], param[2]),
               proc=c(param[3], param[4]),
               pcol=c(param[5], param[6]),
               det=detparam)
  } else if(length(param)==8) {
    pars<-list(obs=c(param[1], param[2]),
               proc=c(param[3], param[4]),
               pcol=c(param[5], param[6]),
               det=c(param[7], param[8]))
  } else {
    return("error: param must be either length 6 or 8")
  }

  return(pars)
}


#' Default likelihood function
#'
#' Calculates likelihood of vector y given parameter values in param, based on the particleFilterLL function.
#' @param param An unformatted vector of parameters, to be passed to parseparam function.
#' @param y A numeric vector of observed values, from which the likelihood of parameters and functions will be determined.
#' @param parseparam A function for transforming the vector param into a form that can be read by particleFilterLL. See particleFilterLL for details.
#' @param N Number of particles to simulate. Defaults to 1e3.
#' @param detfun A function that simulates deterministic dynamics, which takes in arguments sdet (parameters for deterministic model, taken from pars$proc), and xt, observed abundances at time t.
#' Returns estimated abundances at time t+1 based on deterministic function (either a parametric function or an EDM function). Defaults to detfun0.
#' @param edmdat A list including arguments to be passed to block_lnlp from rEDM package - see block_lnlp help file for details. Can also include optional matrix "extra_columns", a matrix with length(y) rows including extra covariates for attractor reconstruction, which defaults to NULL (i.e. no additional columns).
#' Default for edmdat is NULL, which implies that EDM will not be applied - instead, a detfun and pars$det must be included.
#' @keywords stability, time-series, MCMC optimization
#' @return Log likelihood generated by particleFilterLL function
#' @export

likelihood0 <- function(param, y=y, parseparam=parseparam0, N=1e3, detfun=detfun0, edmdat=NULL) {
  pars<-parseparam(param)

  tmp<-particleFilterLL(y, pars, N=N, detfun = detfun, edmdat = edmdat)
  tmp$LL
}


#' Get inverse logit-normal mode
#'
#' Returns a mean for a logit normal such that the mode will be centered around mu
#' @param mu the value around which the mode should be centered (in logit space)
#' @param sd the standard deviation of the logit distribution (in logit space)
#' @keywords MCMC optimization
#' @return the proposed mean for the distribution
#' @export

logitnormal_imode = function(mu, sd){
  mode<-mu - (sd)^2*(2*ilogit(mu)-1)
  return(mode)
}


#' Get inverse log-normal mode
#'
#' Returns a mean for a lognormal such that the mode will be centered around mu
#' @param mu the value around which the mode should be centered (in log space)
#' @param sd the standard deviation of the lognormal distribution (in log space)
#' @keywords MCMC optimization
#' @return the proposed mean for the distribution
#' @export

lognormal_imode = function(mu, sd){
  mode<-mu+sd^2
  return(mode)
}


#' Default density function for prior
#'
#' Default density function, following the syntax for priors in the BayesianTools package. Uses
#' lognormal priors for the intercept and slope of the observation error function, a normal prior for the
#' intercept of the process noise function, a lognormal for the slope of the process noise function,
#' a logit-normal prior for colonization probability, and a lognormal prior for the colonization abundance.
#' Note that prior likelihood is calculated based on values of param, which are centered around the listed values in variable pars.
#' @param param a vector of length 6 or 8 with mean model parameters (or desired centers for prior distributions)
#' @param pars a list of parameter values, structured following the parseparam0 function, specifying the centers for the priors
#' @param priorsd a vector of length 6 or 8 with desired standard deviations for the prior distributions
#' @keywords stability, time-series, MCMC optimization
#' @return returns log likelihood of parameters given priors.
#' @export

density_fun0 = function(param, pars=pars, priorsd=c(1, 1, 3, 1, 1.2, 1)){
  dsum = dnorm(param[1], mean = lognormal_imode(pars$obs[1], priorsd[1]), sd =  priorsd[1], log = TRUE)
  dsum = dsum+dnorm(param[2], mean = lognormal_imode(pars$obs[2], priorsd[2]), sd =  priorsd[2], log = TRUE)
  dsum = dsum+dnorm(param[3], mean = pars$proc[1], sd = priorsd[3], log = TRUE)
  dsum = dsum+dnorm(param[4], mean = lognormal_imode(pars$proc[2], priorsd[4]), sd = priorsd[4], log = TRUE)
  dsum = dsum+dnorm(param[5], mean = logitnormal_imode(pars$pcol[1], priorsd[5]), sd = priorsd[5], log = TRUE)
  dsum = dsum+dnorm(param[6], mean = lognormal_imode(pars$pcol[2], priorsd[6]), sd = priorsd[6], log = TRUE)

  if(length(param)==8) {
    dsum = dsum+dnorm(param[7], mean = lognormal_imode(pars$det[1], priorsd[7]), sd = priorsd[7], log = TRUE)
    dsum = dsum+dnorm(param[8], mean = lognormal_imode(pars$det[2], priorsd[8]), sd = priorsd[8], log = TRUE)
  }

  return(dsum)
}


#' Default sampler function for prior
#'
#' Text...
#' @param n number of random draws to take from the priors
#' @param pars a list of parameter values, structured following the parseparam0 function, specifying the centers for the priors
#' @param priorsd a vector of length 6 or 8 with desired standard deviations for the prior distributions
#' @param minv Minimum value to return - defaults to -9.9
#' @param maxv Maximum value to return - defaults to 9.9
#' @keywords stability, time-series, MCMC optimization
#' @return returns random draws from the priors
#' @import stats
#' @export

sampler_fun0 = function(n=1, pars=pars, priorsd=c(1, 1, 3, 1, 1.2, 1), minv=-9.9, maxv=9.9){
  d1 = rnorm(n, mean = lognormal_imode(pars$obs[1], priorsd[1]), sd = priorsd[1])
  d2 = rnorm(n, mean = lognormal_imode(pars$obs[2], priorsd[2]), sd = priorsd[2])
  d3 = rnorm(n, mean = pars$proc[1], sd = priorsd[3])
  d4 = rnorm(n, mean = lognormal_imode(pars$proc[2], priorsd[4]), sd=priorsd[4])
  d5 = rnorm(n, mean = logitnormal_imode(pars$pcol[1], priorsd[5]), sd = priorsd[5])
  d6 = rnorm(n, mean = lognormal_imode(pars$pcol[2], priorsd[6]), sd=priorsd[6])

  d1[d1<minv]<-minv; d1[d1>maxv]<-maxv
  d2[d2<minv]<-minv; d2[d2>maxv]<-maxv
  d3[d3<minv]<-minv; d3[d3>maxv]<-maxv
  d4[d4<minv]<-minv; d4[d4>maxv]<-maxv
  d5[d5<minv]<-minv; d5[d5>maxv]<-maxv
  d6[d6<minv]<-minv; d6[d6>maxv]<-maxv

  if(length(priorsd)==8) {
    d7 = rnorm(n, mean = lognormal_imode(pars$det[1], priorsd[7]), sd=priorsd[7])
    d8 = rnorm(n, mean = lognormal_imode(pars$det[2], priorsd[8]), sd=priorsd[8])

    d7[d7<minv]<-minv; d7[d7>maxv]<-maxv
    d8[d8<minv]<-minv; d8[d8>maxv]<-maxv

    return(cbind(d1,d2,d3,d4,d5,d6,d7,d8))
  } else {
    return(cbind(d1,d2,d3,d4,d5,d6))
  }
}


#' Default inverse transormation function
#'
#' Takes in a matrix, where each column represents a parameter. Returns parameters in untransformed space.
#' @param x an nxm matrix with
#' @keywords stability, time-series, MCMC optimization
#' @return returns back-transformed values of parameters
#' @export

inv_fun0<-function(x) {
  if(ncol(x)==6) {
    cbind(exp(x[,1]), exp(x[,2]), x[,3], exp(x[,4]), ilogit(x[,5]), exp(x[,6]))
  } else {
    cbind(exp(x[,1]), exp(x[,2]), x[,3], exp(x[,4]), ilogit(x[,5]), exp(x[,6]), exp(x[,7]), exp(x[,8]))
  }
}
